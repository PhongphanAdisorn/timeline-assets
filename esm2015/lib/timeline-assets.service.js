import { HttpClient, HttpEventType, HttpRequest, HttpResponse } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
const BaseServer = "https://highwaydistrict.com/doh_district/api";
export class TimelineAssetsService {
    constructor(http) {
        this.http = http;
        this.baseUrl = BaseServer;
        this.tools = new AppTools;
    }
    /**
        * Create new maintenance history
        * @param data | Object
        * @returns Promise
      */
    createMaintenance(data) {
        const url = `${this.baseUrl}/timeline/create-maintenance`;
        const params = this.tools.genFormData(data);
        return this.http.post(url, params).pipe(map((res) => res === null || res === void 0 ? void 0 : res.data)).toPromise();
    }
    /**
      * Create new condition report
      * @param data | Object
      * @returns Promise
    */
    createConditionReport(data) {
        const url = `${this.baseUrl}/timeline/create-condition`;
        const params = this.tools.genFormData(data);
        return this.http.post(url, params).pipe(map((res) => res === null || res === void 0 ? void 0 : res.data)).toPromise();
    }
    /** =========================================================================
     * Upload file to timline
     * @param assetType
     * @param assetId
     * @param file
     * @returns Observable
     */
    uploadFile(mainId, assetType, assetId, file, isMaintenance) {
        const formData = new FormData();
        formData.append('mainId', mainId);
        formData.append('assetType', assetType);
        formData.append('assetId', assetId);
        formData.append('file', file);
        const maintenance = (isMaintenance) ? '/maintenance' : '';
        const url = `${this.baseUrl}/timeline/upload-file${maintenance}`;
        const request = new HttpRequest('POST', url, formData, {
            reportProgress: true,
            responseType: 'json'
        });
        return this.http.request(request).pipe(map((event) => {
            //-- Uploading...
            if (event.type === HttpEventType.UploadProgress)
                return Math.round(100 * event.loaded / event.total);
            //-- Uploaded
            // if (event.type === 3) return 100;
            //-- Uploaded response
            if (event instanceof HttpResponse)
                return event.body;
            //-- orther
            return event;
        }));
    }
    /** ======================================================================
     * Download file
     * */
    downloadFile(assetType, assetId, fileName) {
        const formData = new FormData();
        const url = `${this.baseUrl}/timeline/download/${assetType}/${assetId}/${fileName}`;
        const request = new HttpRequest('POST', url, formData, {
            reportProgress: true,
            responseType: 'blob'
        });
        return this.http.request(request).pipe(map((event) => {
            //-- loading... HttpHeaderResponse
            if (event.type === HttpEventType.DownloadProgress)
                return event.loaded;
            //-- response
            if (event instanceof HttpResponse)
                return event.body;
            //-- orther
            return event;
        }));
    }
    /** ======================================================================
     * Load timeline data
     * =====================================================================*/
    getTimeline(assetType, assetId, period, periodType) {
        const formData = new FormData();
        formData.append('assetType', assetType);
        formData.append('assetId', assetId);
        if (period)
            formData.append('period', period);
        if (periodType)
            formData.append('periodType', periodType);
        const url = `${this.baseUrl}/timeline/asset-timeline`;
        return this.http.post(url, formData).pipe(map((res) => res === null || res === void 0 ? void 0 : res.data)).toPromise();
    }
    getMaintenanceHistoryWithFile(mainId) {
        const url = `${this.baseUrl}/timeline/maintenance-history/${mainId}`;
        return this.http.get(url).pipe(map((res) => res === null || res === void 0 ? void 0 : res.data)).toPromise();
    }
    getConditionReportWithFile(mainId) {
        const url = `${this.baseUrl}/timeline/condition-report/${mainId}`;
        return this.http.get(url).pipe(map((res) => res === null || res === void 0 ? void 0 : res.data)).toPromise();
    }
}
TimelineAssetsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TimelineAssetsService_Factory() { return new TimelineAssetsService(i0.ɵɵinject(i1.HttpClient)); }, token: TimelineAssetsService, providedIn: "root" });
TimelineAssetsService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
TimelineAssetsService.ctorParameters = () => [
    { type: HttpClient }
];
// app tools gan form data
export class AppTools {
    constructor() {
        this.twoDigi = (num) => (`0${num}`).slice(-2);
    }
    // gan form data
    genFormData(object, form, namespace) {
        const formData = form || new FormData();
        for (let property in object) {
            if (object.hasOwnProperty(property) && object[property] != null && object[property] !== undefined) {
                const formKey = namespace ? `${namespace}[${property}]` : property;
                if (object[property] instanceof Date) {
                    formData.append(formKey, object[property].toISOString());
                }
                else if (typeof object[property] === 'object' && !(object[property] instanceof File)) {
                    this.genFormData(object[property], formData, formKey);
                }
                else {
                    formData.append(formKey, object[property]);
                }
                continue;
            }
        }
        return formData;
    }
    /** Create date time format
     * @param date : Date
     * @return string : 'yyyy-MM-dd HH:mm:ss'
    */
    dateTimeFormat(date) {
        if (!date)
            return null;
        const fTime = `${this.twoDigi(date.getHours())}:${this.twoDigi(date.getMinutes())}:00`;
        return `${date.getFullYear()}-${this.twoDigi(date.getMonth() + 1)}-${this.twoDigi(date.getDate())} ${fTime}`;
    }
}
// budget list api
export class BudgetCodeService {
    constructor(http) {
        this.http = http;
        this.baseUrl = BaseServer;
        this.tools = new AppTools;
    }
    createWithUpdate(params) {
        const url = `${this.baseUrl}/budget-code/create-update`;
        const formData = this.tools.genFormData(params);
        return this.http.post(url, formData).pipe(map((res) => (res === null || res === void 0 ? void 0 : res.data) ? res.data : res)).toPromise();
    }
    /** =================================================================================================
     * Upload file with progress single file only.
     * @param assetTable
     * @param budgetCode
     * @param file
     * @returns Observable
     */
    uploadFile(assetTable, budgetCode, file) {
        const url = `${this.baseUrl}/budget-code/upload-file`;
        const formData = new FormData();
        formData.append('assetType', assetTable);
        formData.append('budgetCode', String(budgetCode).trim());
        formData.append('file', file);
        const request = new HttpRequest('POST', url, formData, {
            reportProgress: true,
            responseType: 'json'
        });
        return this.http.request(request).pipe(map((event) => {
            //-- Uploading...
            if (event.type === HttpEventType.UploadProgress)
                return Math.round(100 * event.loaded / event.total);
            //-- Uploaded response
            if (event instanceof HttpResponse)
                return event.body;
            //-- orther
            return event;
        }));
    }
    /** ======================================================================
     * Download file
     * */
    downloadFile(assetType, fileName) {
        const formData = new FormData();
        const url = `${this.baseUrl}/budget-code/download/${assetType}/${fileName}`;
        const request = new HttpRequest('POST', url, formData, {
            reportProgress: true,
            responseType: 'blob'
        });
        return this.http.request(request).pipe(map((event) => {
            //-- loading... HttpHeaderResponse
            if (event.type === HttpEventType.DownloadProgress)
                return event.loaded;
            //-- response
            if (event instanceof HttpResponse)
                return event.body;
            //-- orther
            return event;
        }));
    }
    /** Finding budget-code */
    findBudgetCode(isAll, assetTable, budgetCode) {
        const findAll = (isAll) ? '/all' : '';
        const url = `${this.baseUrl}/budget-code/find-code${findAll}`;
        const formData = this.tools.genFormData({ assetType: assetTable, findCode: String(budgetCode).trim() });
        return this.http.post(url, formData).pipe(map((res) => (res === null || res === void 0 ? void 0 : res.data) ? res.data : res)).toPromise();
    }
    /** Get asset to used budget-code */
    getAssetUsedCode(budgetCode) {
        const url = `${this.baseUrl}/budget-code/asset-used`;
        const formData = this.tools.genFormData({ budgetCode: budgetCode });
        return this.http.post(url, formData).pipe(map((res) => (res === null || res === void 0 ? void 0 : res.data) ? res.data : res)).toPromise();
    }
}
BudgetCodeService.ɵprov = i0.ɵɵdefineInjectable({ factory: function BudgetCodeService_Factory() { return new BudgetCodeService(i0.ɵɵinject(i1.HttpClient)); }, token: BudgetCodeService, providedIn: "root" });
BudgetCodeService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
BudgetCodeService.ctorParameters = () => [
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZWxpbmUtYXNzZXRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy90aW1lbGluZS1hc3NldHMvc3JjL2xpYi90aW1lbGluZS1hc3NldHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFhLGFBQWEsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7OztBQUVyQyxNQUFNLFVBQVUsR0FBVyw4Q0FBOEMsQ0FBQztBQUsxRSxNQUFNLE9BQU8scUJBQXFCO0lBR2hDLFlBQ1UsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUhoQixZQUFPLEdBQVcsVUFBVSxDQUFDO1FBS3JDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxRQUFRLENBQUM7SUFDNUIsQ0FBQztJQUVEOzs7O1FBSUk7SUFDSSxpQkFBaUIsQ0FBQyxJQUFZO1FBQ3BDLE1BQU0sR0FBRyxHQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sOEJBQThCLENBQUM7UUFDbEUsTUFBTSxNQUFNLEdBQWEsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFLENBQUMsR0FBRyxhQUFILEdBQUcsdUJBQUgsR0FBRyxDQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDdEYsQ0FBQztJQUNEOzs7O01BSUU7SUFDSyxxQkFBcUIsQ0FBQyxJQUFZO1FBQ3JDLE1BQU0sR0FB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LENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxhQUFILEdBQUcsdUJBQUgsR0FBRyxDQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQzNHLENBQUM7Ozs7WUFqRkosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUE5SlEsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFdmVudCwgSHR0cEV2ZW50VHlwZSwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL2ludGVybmFsL09ic2VydmFibGUnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5jb25zdCBCYXNlU2VydmVyOiBzdHJpbmcgPSBcImh0dHBzOi8vaGlnaHdheWRpc3RyaWN0LmNvbS9kb2hfZGlzdHJpY3QvYXBpXCI7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRpbWVsaW5lQXNzZXRzU2VydmljZSB7XG4gIHByb3RlY3RlZCBiYXNlVXJsOiBzdHJpbmcgPSBCYXNlU2VydmVyOyBcbiAgcHJvdGVjdGVkIHRvb2xzOiBBcHBUb29scztcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50XG4gICkge1xuICAgIHRoaXMudG9vbHMgPSBuZXcgQXBwVG9vbHM7XG4gIH1cblxuICAvKipcbiAgICAgICogQ3JlYXRlIG5ldyBtYWludGVuYW5jZSBoaXN0b3J5XG4gICAgICAqIEBwYXJhbSBkYXRhIHwgT2JqZWN0XG4gICAgICAqIEByZXR1cm5zIFByb21pc2VcbiAgICAqL1xuICAgcHVibGljIGNyZWF0ZU1haW50ZW5hbmNlKGRhdGE6IG9iamVjdCkge1xuICAgIGNvbnN0IHVybDogc3RyaW5nID0gYCR7dGhpcy5iYXNlVXJsfS90aW1lbGluZS9jcmVhdGUtbWFpbnRlbmFuY2VgO1xuICAgIGNvbnN0IHBhcmFtczogRm9ybURhdGEgPSB0aGlzLnRvb2xzLmdlbkZvcm1EYXRhKGRhdGEpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIHBhcmFtcykucGlwZShtYXAoKHJlczogYW55KSA9PiByZXM/LmRhdGEpKS50b1Byb21pc2UoKTtcbn1cbi8qKlxuICAqIENyZWF0ZSBuZXcgY29uZGl0aW9uIHJlcG9ydFxuICAqIEBwYXJhbSBkYXRhIHwgT2JqZWN0XG4gICogQHJldHVybnMgUHJvbWlzZVxuKi9cbnB1YmxpYyBjcmVhdGVDb25kaXRpb25SZXBvcnQoZGF0YTogb2JqZWN0KSB7XG4gICAgY29uc3QgdXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L3RpbWVsaW5lL2NyZWF0ZS1jb25kaXRpb25gO1xuICAgIGNvbnN0IHBhcmFtczogRm9ybURhdGEgPSB0aGlzLnRvb2xzLmdlbkZvcm1EYXRhKGRhdGEpO1xuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIHBhcmFtcykucGlwZShtYXAoKHJlczogYW55KSA9PiByZXM/LmRhdGEpKS50b1Byb21pc2UoKTtcbn1cblxuLyoqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAqIFVwbG9hZCBmaWxlIHRvIHRpbWxpbmVcbiAqIEBwYXJhbSBhc3NldFR5cGUgXG4gKiBAcGFyYW0gYXNzZXRJZCBcbiAqIEBwYXJhbSBmaWxlIFxuICogQHJldHVybnMgT2JzZXJ2YWJsZVxuICovXG5wdWJsaWMgdXBsb2FkRmlsZShtYWluSWQ6IHN0cmluZywgYXNzZXRUeXBlOiBzdHJpbmcsIGFzc2V0SWQ6IHN0cmluZywgZmlsZTogRmlsZSwgaXNNYWludGVuYW5jZTogYm9vbGVhbik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ21haW5JZCcsIG1haW5JZCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKCdhc3NldFR5cGUnLCBhc3NldFR5cGUpO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgnYXNzZXRJZCcsIGFzc2V0SWQpO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgIGNvbnN0IG1haW50ZW5hbmNlID0gKGlzTWFpbnRlbmFuY2UpID8gJy9tYWludGVuYW5jZScgOiAnJztcbiAgICBjb25zdCB1cmw6IHN0cmluZyA9IGAke3RoaXMuYmFzZVVybH0vdGltZWxpbmUvdXBsb2FkLWZpbGUke21haW50ZW5hbmNlfWA7XG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBIdHRwUmVxdWVzdCgnUE9TVCcsIHVybCwgZm9ybURhdGEsIHtcbiAgICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWUsXG4gICAgICAgIHJlc3BvbnNlVHlwZTogJ2pzb24nXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5yZXF1ZXN0KHJlcXVlc3QpLnBpcGUoXG4gICAgICAgIG1hcCgoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgLy8tLSBVcGxvYWRpbmcuLi5cbiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSBIdHRwRXZlbnRUeXBlLlVwbG9hZFByb2dyZXNzKSByZXR1cm4gTWF0aC5yb3VuZCgxMDAgKiBldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCk7XG4gICAgICAgICAgICAvLy0tIFVwbG9hZGVkXG4gICAgICAgICAgICAvLyBpZiAoZXZlbnQudHlwZSA9PT0gMykgcmV0dXJuIDEwMDtcbiAgICAgICAgICAgIC8vLS0gVXBsb2FkZWQgcmVzcG9uc2VcbiAgICAgICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkgcmV0dXJuIGV2ZW50LmJvZHk7XG4gICAgICAgICAgICAvLy0tIG9ydGhlclxuICAgICAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgICB9KVxuICAgICk7XG59XG4vKiogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICogRG93bmxvYWQgZmlsZVxuICogKi9cbnB1YmxpYyBkb3dubG9hZEZpbGUoYXNzZXRUeXBlOiBzdHJpbmcsIGFzc2V0SWQ6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBjb25zdCB1cmw6IHN0cmluZyA9IGAke3RoaXMuYmFzZVVybH0vdGltZWxpbmUvZG93bmxvYWQvJHthc3NldFR5cGV9LyR7YXNzZXRJZH0vJHtmaWxlTmFtZX1gO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgSHR0cFJlcXVlc3QoJ1BPU1QnLCB1cmwsIGZvcm1EYXRhLCB7XG4gICAgICAgIHJlcG9ydFByb2dyZXNzOiB0cnVlLFxuICAgICAgICByZXNwb25zZVR5cGU6ICdibG9iJyBhcyAnanNvbidcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5odHRwLnJlcXVlc3QocmVxdWVzdCkucGlwZShcbiAgICAgICAgbWFwKChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAvLy0tIGxvYWRpbmcuLi4gSHR0cEhlYWRlclJlc3BvbnNlXG4gICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5Eb3dubG9hZFByb2dyZXNzKSByZXR1cm4gZXZlbnQubG9hZGVkO1xuICAgICAgICAgICAgLy8tLSByZXNwb25zZVxuICAgICAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSByZXR1cm4gZXZlbnQuYm9keTtcbiAgICAgICAgICAgIC8vLS0gb3J0aGVyXG4gICAgICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgICAgIH0pXG4gICAgKTtcbn1cblxuLyoqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAqIExvYWQgdGltZWxpbmUgZGF0YSBcbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG5cbnB1YmxpYyBnZXRUaW1lbGluZShhc3NldFR5cGU6IHN0cmluZywgYXNzZXRJZDogc3RyaW5nLCBwZXJpb2Q/OiBzdHJpbmcsIHBlcmlvZFR5cGU/OiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGZvcm1EYXRhOiBGb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgnYXNzZXRUeXBlJywgYXNzZXRUeXBlKTtcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ2Fzc2V0SWQnLCBhc3NldElkKTtcbiAgICBpZiAocGVyaW9kKSBmb3JtRGF0YS5hcHBlbmQoJ3BlcmlvZCcsIHBlcmlvZCk7XG4gICAgaWYgKHBlcmlvZFR5cGUpIGZvcm1EYXRhLmFwcGVuZCgncGVyaW9kVHlwZScsIHBlcmlvZFR5cGUpO1xuICAgIGNvbnN0IHVybDogc3RyaW5nID0gYCR7dGhpcy5iYXNlVXJsfS90aW1lbGluZS9hc3NldC10aW1lbGluZWA7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgZm9ybURhdGEpLnBpcGUobWFwKChyZXM6IGFueSkgPT4gcmVzPy5kYXRhKSkudG9Qcm9taXNlKCk7XG59XG5cbnB1YmxpYyBnZXRNYWludGVuYW5jZUhpc3RvcnlXaXRoRmlsZShtYWluSWQ6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgdXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L3RpbWVsaW5lL21haW50ZW5hbmNlLWhpc3RvcnkvJHttYWluSWR9YDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwpLnBpcGUobWFwKChyZXM6IGFueSkgPT4gcmVzPy5kYXRhKSkudG9Qcm9taXNlKCk7XG59XG5wdWJsaWMgZ2V0Q29uZGl0aW9uUmVwb3J0V2l0aEZpbGUobWFpbklkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHVybDogc3RyaW5nID0gYCR7dGhpcy5iYXNlVXJsfS90aW1lbGluZS9jb25kaXRpb24tcmVwb3J0LyR7bWFpbklkfWA7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKG1hcCgocmVzOiBhbnkpID0+IHJlcz8uZGF0YSkpLnRvUHJvbWlzZSgpO1xufVxuXG5cbn1cblxuXG4vLyBhcHAgdG9vbHMgZ2FuIGZvcm0gZGF0YVxuZXhwb3J0IGNsYXNzIEFwcFRvb2xze1xuICBjb25zdHJ1Y3Rvcigpe31cbiAgLy8gZ2FuIGZvcm0gZGF0YVxuICBwdWJsaWMgZ2VuRm9ybURhdGEob2JqZWN0OiBPYmplY3QsIGZvcm0/OiBGb3JtRGF0YSwgbmFtZXNwYWNlPzogc3RyaW5nKTogRm9ybURhdGEge1xuICAgIGNvbnN0IGZvcm1EYXRhID0gZm9ybSB8fCBuZXcgRm9ybURhdGEoKVxuICAgIGZvciAobGV0IHByb3BlcnR5IGluIG9iamVjdCkge1xuICAgICAgICBpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBvYmplY3RbcHJvcGVydHldICE9IG51bGwgJiYgb2JqZWN0W3Byb3BlcnR5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCBmb3JtS2V5ID0gbmFtZXNwYWNlID8gYCR7bmFtZXNwYWNlfVske3Byb3BlcnR5fV1gIDogcHJvcGVydHlcbiAgICAgICAgICAgIGlmIChvYmplY3RbcHJvcGVydHldIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChmb3JtS2V5LCBvYmplY3RbcHJvcGVydHldLnRvSVNPU3RyaW5nKCkpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmplY3RbcHJvcGVydHldID09PSAnb2JqZWN0JyAmJiAhKG9iamVjdFtwcm9wZXJ0eV0gaW5zdGFuY2VvZiBGaWxlKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZ2VuRm9ybURhdGEob2JqZWN0W3Byb3BlcnR5XSwgZm9ybURhdGEsIGZvcm1LZXkpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChmb3JtS2V5LCBvYmplY3RbcHJvcGVydHldKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZm9ybURhdGFcbiAgfVxuXG4gICAgcHJpdmF0ZSB0d29EaWdpID0gKG51bTogbnVtYmVyKTogc3RyaW5nID0+IChgMCR7bnVtfWApLnNsaWNlKC0yKTtcbiAgICAvKiogQ3JlYXRlIGRhdGUgdGltZSBmb3JtYXQgXG4gICAgICogQHBhcmFtIGRhdGUgOiBEYXRlXG4gICAgICogQHJldHVybiBzdHJpbmcgOiAneXl5eS1NTS1kZCBISDptbTpzcydcbiAgICAqL1xuICAgIHB1YmxpYyBkYXRlVGltZUZvcm1hdChkYXRlOiBEYXRlKTogc3RyaW5nIHtcbiAgICAgICAgaWYoIWRhdGUpIHJldHVybiBudWxsO1xuICAgICAgICBjb25zdCBmVGltZTogc3RyaW5nID0gYCR7dGhpcy50d29EaWdpKGRhdGUuZ2V0SG91cnMoKSl9OiR7dGhpcy50d29EaWdpKGRhdGUuZ2V0TWludXRlcygpKX06MDBgO1xuICAgICAgICByZXR1cm4gYCR7ZGF0ZS5nZXRGdWxsWWVhcigpfS0ke3RoaXMudHdvRGlnaShkYXRlLmdldE1vbnRoKCkgKyAxKX0tJHt0aGlzLnR3b0RpZ2koZGF0ZS5nZXREYXRlKCkpfSAke2ZUaW1lfWA7XG4gICAgfVxufVxuXG4vLyBidWRnZXQgbGlzdCBhcGlcbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQnVkZ2V0Q29kZVNlcnZpY2Uge1xuXG4gICAgcHJvdGVjdGVkIGJhc2VVcmw6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgdG9vbHM6IEFwcFRvb2xzO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7XG4gICAgICAgIHRoaXMuYmFzZVVybCA9IEJhc2VTZXJ2ZXI7XG4gICAgICAgIHRoaXMudG9vbHMgPSBuZXcgQXBwVG9vbHM7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZVdpdGhVcGRhdGUocGFyYW1zOiBvYmplY3QpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCB1cmw6IHN0cmluZyA9IGAke3RoaXMuYmFzZVVybH0vYnVkZ2V0LWNvZGUvY3JlYXRlLXVwZGF0ZWA7XG4gICAgICAgIGNvbnN0IGZvcm1EYXRhOiBGb3JtRGF0YSA9IHRoaXMudG9vbHMuZ2VuRm9ybURhdGEocGFyYW1zKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgZm9ybURhdGEpLnBpcGUobWFwKChyZXM6IGFueSkgPT4gKHJlcz8uZGF0YSkgPyByZXMuZGF0YSA6IHJlcykpLnRvUHJvbWlzZSgpO1xuICAgIH1cblxuICAgIC8qKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICogVXBsb2FkIGZpbGUgd2l0aCBwcm9ncmVzcyBzaW5nbGUgZmlsZSBvbmx5LlxuICAgICAqIEBwYXJhbSBhc3NldFRhYmxlIFxuICAgICAqIEBwYXJhbSBidWRnZXRDb2RlIFxuICAgICAqIEBwYXJhbSBmaWxlIFxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGVcbiAgICAgKi9cbiAgICBwdWJsaWMgdXBsb2FkRmlsZShhc3NldFRhYmxlOiBzdHJpbmcsIGJ1ZGdldENvZGU6IHN0cmluZywgZmlsZTogRmlsZSk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICAgICAgY29uc3QgdXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L2J1ZGdldC1jb2RlL3VwbG9hZC1maWxlYDtcbiAgICAgICAgY29uc3QgZm9ybURhdGE6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYXNzZXRUeXBlJywgYXNzZXRUYWJsZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYnVkZ2V0Q29kZScsIFN0cmluZyhidWRnZXRDb2RlKS50cmltKCkpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBmaWxlKTtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBIdHRwUmVxdWVzdCgnUE9TVCcsIHVybCwgZm9ybURhdGEsIHtcbiAgICAgICAgICAgIHJlcG9ydFByb2dyZXNzOiB0cnVlLFxuICAgICAgICAgICAgcmVzcG9uc2VUeXBlOiAnanNvbidcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucmVxdWVzdChyZXF1ZXN0KS5waXBlKFxuICAgICAgICAgICAgbWFwKChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgLy8tLSBVcGxvYWRpbmcuLi5cbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5VcGxvYWRQcm9ncmVzcykgcmV0dXJuIE1hdGgucm91bmQoMTAwICogZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwpO1xuICAgICAgICAgICAgICAgIC8vLS0gVXBsb2FkZWQgcmVzcG9uc2VcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHJldHVybiBldmVudC5ib2R5O1xuICAgICAgICAgICAgICAgIC8vLS0gb3J0aGVyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG4gICAgLyoqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgKiBEb3dubG9hZCBmaWxlXG4gICAgICogKi9cbiAgICBwdWJsaWMgZG93bmxvYWRGaWxlKGFzc2V0VHlwZTogc3RyaW5nLCBmaWxlTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgICAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgY29uc3QgdXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L2J1ZGdldC1jb2RlL2Rvd25sb2FkLyR7YXNzZXRUeXBlfS8ke2ZpbGVOYW1lfWA7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgSHR0cFJlcXVlc3QoJ1BPU1QnLCB1cmwsIGZvcm1EYXRhLCB7XG4gICAgICAgICAgICByZXBvcnRQcm9ncmVzczogdHJ1ZSxcbiAgICAgICAgICAgIHJlc3BvbnNlVHlwZTogJ2Jsb2InIGFzICdqc29uJ1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5yZXF1ZXN0KHJlcXVlc3QpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAvLy0tIGxvYWRpbmcuLi4gSHR0cEhlYWRlclJlc3BvbnNlXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuRG93bmxvYWRQcm9ncmVzcykgcmV0dXJuIGV2ZW50LmxvYWRlZDtcbiAgICAgICAgICAgICAgICAvLy0tIHJlc3BvbnNlXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSByZXR1cm4gZXZlbnQuYm9keTtcbiAgICAgICAgICAgICAgICAvLy0tIG9ydGhlclxuICAgICAgICAgICAgICAgIHJldHVybiBldmVudDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqIEZpbmRpbmcgYnVkZ2V0LWNvZGUgKi9cbiAgICBwdWJsaWMgZmluZEJ1ZGdldENvZGUoaXNBbGw6IGJvb2xlYW4sIGFzc2V0VGFibGU6IHN0cmluZywgYnVkZ2V0Q29kZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGZpbmRBbGw6IHN0cmluZyA9IChpc0FsbCkgPyAnL2FsbCcgOiAnJztcbiAgICAgICAgY29uc3QgdXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L2J1ZGdldC1jb2RlL2ZpbmQtY29kZSR7ZmluZEFsbH1gO1xuICAgICAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSB0aGlzLnRvb2xzLmdlbkZvcm1EYXRhKHsgYXNzZXRUeXBlOiBhc3NldFRhYmxlLCBmaW5kQ29kZTogU3RyaW5nKGJ1ZGdldENvZGUpLnRyaW0oKSB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgZm9ybURhdGEpLnBpcGUobWFwKChyZXM6IGFueSkgPT4gKHJlcz8uZGF0YSkgPyByZXMuZGF0YSA6IHJlcykpLnRvUHJvbWlzZSgpO1xuICAgIH1cbiAgICAvKiogR2V0IGFzc2V0IHRvIHVzZWQgYnVkZ2V0LWNvZGUgKi9cbiAgICBwdWJsaWMgZ2V0QXNzZXRVc2VkQ29kZShidWRnZXRDb2RlOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgdXJsOiBzdHJpbmcgPSBgJHt0aGlzLmJhc2VVcmx9L2J1ZGdldC1jb2RlL2Fzc2V0LXVzZWRgO1xuICAgICAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSB0aGlzLnRvb2xzLmdlbkZvcm1EYXRhKHsgYnVkZ2V0Q29kZTogYnVkZ2V0Q29kZSB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgZm9ybURhdGEpLnBpcGUobWFwKChyZXM6IGFueSkgPT4gKHJlcz8uZGF0YSkgPyByZXMuZGF0YSA6IHJlcykpLnRvUHJvbWlzZSgpO1xuICAgIH1cbn1cblxuIl19